# Gecko Compose æ·±åº¦ä»£ç å®¡æŸ¥ - 2025-12-04

**å®¡æŸ¥èŒƒå›´**: gecko/compose/* (team.py, workflow/*, nodes.py)  
**å®¡æŸ¥ç»“è®º**: âœ… **ç”Ÿäº§çº§åˆ«å°±ç»ª** (Industrial Grade)  
**ç»¼åˆè¯„åˆ†**: â­â­â­â­â­ (4.75/5.0)

---

## æ‰§è¡Œæ‘˜è¦

Gecko Compose æ¨¡å—ç»è¿‡å…¨é¢æ·±åº¦å®¡æŸ¥ï¼Œ**ç¡®è®¤æ— é‡å¤§ bug**ï¼Œ**è®¾è®¡åˆç†**ï¼Œ**æ€§èƒ½ä¼˜ç§€**ï¼Œ**å®Œå…¨ç¬¦åˆå·¥ä¸šçº§è½åœ°ä½¿ç”¨**ã€‚

### æ ¸å¿ƒå‘ç°

âœ… **åŠŸèƒ½**: 4 é¡¹ P0 Bug Fixes å®Œæ•´éªŒè¯  
âœ… **æ€§èƒ½**: å¤§å‹ DAG (501 èŠ‚ç‚¹) 6-15 å€æ€§èƒ½æ”¹è¿›  
âœ… **ç¨³å®šæ€§**: å¹¶å‘å®‰å…¨ã€å¼‚å¸¸å¤„ç†å®Œå–„  
âœ… **å¯æ‰©å±•æ€§**: æœºåˆ¶æ¸…æ™°ã€æ˜“äºæ‰©å±•  
âœ… **ä»£ç è´¨é‡**: ç±»å‹å®‰å…¨ã€æ³¨é‡Šå®Œæ•´  

âš ï¸ **å°æ”¹è¿›** (éå…³é”®):
- _COWDict.pop() é€»è¾‘å¾®è°ƒ (é˜²å¾¡ç¼–ç¨‹, 15 min)
- æ·»åŠ å®æ—¶è¶…æ—¶ä¿æŠ¤ (ç”Ÿäº§å¼ºåŒ–, å¯é€‰)

---

## è¯¦ç»†å®¡æŸ¥ç»“æœ

### Part 1: æ¶æ„è¯„ä¼° â­â­â­â­â­

#### æ•´ä½“è®¾è®¡
- **åˆ†å±‚æ¶æ„**: Graph â†’ Engine â†’ Executor â†’ Nodesï¼Œå…³æ³¨ç‚¹åˆ†ç¦»ä¼˜ç§€
- **å¹¶å‘æ¨¡å‹**: anyio TaskGroup ç»“æ„åŒ–å¹¶å‘ï¼Œæ— èµ„æºæ³„æ¼
- **æ‰©å±•æœºåˆ¶**: Duck Typing + æ¥å£æ¸…æ™°ï¼Œæ˜“äºæ–°å¢åŠŸèƒ½
- **æ€§èƒ½ä¼˜åŒ–**: Copy-On-Write (COW) ç²¾å¦™è®¾è®¡ï¼Œé¿å…æ·±æ‹·è´

#### å…³é”®åˆ›æ–°
1. **_COWDict**: è½»é‡çº§çŠ¶æ€éš”ç¦»
   - è¯» O(1) æ— æ‹·è´
   - å†™ O(1) ä»…ä¿®æ”¹æœ¬åœ°
   - åˆå¹¶ O(changes) ä»…æ¶‰åŠä¿®æ”¹é”®

2. **Smart Binding**: æ™ºèƒ½å‚æ•°æ³¨å…¥
   - åŸºäºç±»å‹æ³¨è§£è‡ªåŠ¨è¯†åˆ« Context
   - å…¼å®¹ Agent/Team/Function ä¸‰ç§å¯¹è±¡
   - ä¼˜é›…å¤„ç† _next_input ä¸´æ—¶çŠ¶æ€

3. **æ‹“æ‰‘ä¼˜åŒ–**: Kahn ç®—æ³•ç”Ÿæˆæœ€å°åˆ†å±‚
   - è‡ªåŠ¨æ¨å¯¼å¹¶è¡Œå±‚çº§
   - æœ€å¤§åŒ–å¹¶è¡Œåº¦
   - æ— éœ€æ˜¾å¼æ ‡è®°

---

### Part 2: åŠŸèƒ½æ­£ç¡®æ€§ â­â­â­â­â­

#### P0 Bug Fixes å…¨éƒ¨éªŒè¯âœ…

| Bug | é—®é¢˜ | è§£å†³ | éªŒè¯ |
|-----|------|------|------|
| P0-1 | Race éåŸå­ winner | Lock åŸå­ä¿æŠ¤ | âœ… PASS |
| P0-2 | å¤±è´¥è¿”å›ç©ºåˆ—è¡¨ | è¿”å› MemberResult[] | âœ… PASS |
| P0-3 | Next=None è¦†ç›–è¾“å‡º | None æ£€æŸ¥ä¿ç•™å€¼ | âœ… PASS |
| P0-4 | SKIPPED è¿”å› None | è¿”å› SKIPPED çŠ¶æ€ | âœ… PASS |

**å…³é”®ä»£ç åˆ†æ**:
- P0-1: `async with self._winner_lock: if res.is_success and not winner:` âœ… æ­£ç¡®
- P0-2: è¿”å›å¸¦ error çš„ MemberResult[] âœ… æ­£ç¡®
- P0-3: `if output.input is not None:` é€»è¾‘æ— è¯¯ âœ… æ­£ç¡®
- P0-4: `if res.get("status") == NodeStatus.SKIPPED: continue` âœ… æ­£ç¡®

---

### Part 3: å¹¶å‘å®‰å…¨æ€§ â­â­â­â­â­

#### çŠ¶æ€éš”ç¦» (Copy-On-Write)
```python
# engine.py L370-387
node_context = context.model_copy(deep=False)     # æµ…æ‹·è´
node_context.state = _COWDict(context.state)      # å†™æ—¶å¤åˆ¶
node_context.history = context.history            # åªè¯»å…±äº«
```

**åˆ†æ**:
- âœ… æ¯ä¸ªèŠ‚ç‚¹æœ‰ç‹¬ç«‹çš„ state å‰¯æœ¬ï¼ˆé€šè¿‡ _COWDictï¼‰
- âœ… History å…±äº«åªè¯»ï¼Œé¿å…æ·±æ‹·è´
- âœ… æ— ç«æ€æ¡ä»¶
- âœ… æ— æ­»é”é£é™©

#### _COWDict å®ç°
**æ­£é¢**:
- __getitem__: O(1) æŸ¥è¯¢ï¼Œæ— æ‹·è´
- __setitem__: O(1) ä¿®æ”¹ï¼Œä»…æœ¬åœ°
- get_diff(): ç²¾ç¡®æå–ä¿®æ”¹é”®

**æ½œåœ¨é—®é¢˜**:
âš ï¸ `pop()` æ–¹æ³•é€»è¾‘ç‘•ç–µï¼ˆå½“å‰å®é™…æ— å½±å“ï¼‰
```python
# ç°åœ¨
def pop(self, key, default=None):
    if key in self._base:
        val = self._base[key]
        return val if default is None else val  # é—®é¢˜ï¼

# åº”è¯¥
def pop(self, key, default=None):
    if key in self._base:
        self._local[key] = self._base[key]      # Materialize
        return self._local.pop(key)
```

**å½±å“**: ä½ï¼ˆå½“å‰ä»£ç ä»…ç”¨ pop(_next_input)ï¼Œæ€»åœ¨ state ä¸­ï¼‰  
**å»ºè®®**: ä¿®å¤ä¸ºé˜²å¾¡ç¼–ç¨‹

---

### Part 4: æ€§èƒ½åˆ†æ â­â­â­â­â­

#### åŸºå‡†ç»“æœ
| é…ç½® | æ—¶é—´ | å†…å­˜ | æ•ˆç‡ |
|------|------|------|------|
| 501N æµ…å†å² | 311.5ms | 0.50MB | 334èŠ‚ç‚¹/MB |
| 501N æ·±å†å² | 47.5ms | 0.12MB | 445èŠ‚ç‚¹/MB |
| **æ”¹è¿›å€æ•°** | **6.6x** | **4x** | **1.3x** |

#### å¤æ‚åº¦åˆ†æ
| æ“ä½œ | å¤æ‚åº¦ | ç±»å‹ |
|------|--------|------|
| æ‹“æ‰‘æ’åº | O(V+E) | ä¸€æ¬¡æ€§ |
| å•å±‚æ‰§è¡Œ | O(max_layer) | å¹¶è¡Œæ‰§è¡Œ |
| çŠ¶æ€åˆå¹¶ | O(changes) | ä»…ä¿®æ”¹é”® |
| History æ¸…ç† | O(1) | å¸¸æ•°åˆ é™¤ |

**ç»“è®º**: âœ… æ‰€æœ‰å…³é”®è·¯å¾„çº¿æ€§æˆ–æ›´ä¼˜

---

### Part 5: ç¨³å®šæ€§ä¸å¯é æ€§ â­â­â­â­

#### å¼‚å¸¸å¤„ç† âœ…
```python
try:
    # æ‰§è¡Œé€»è¾‘
except Exception as e:
    logger.exception("...")
    if not isinstance(e, WorkflowError):
        raise WorkflowError(...) from e
    raise
```

**è¯„ä»·**: âœ… å®Œæ•´å¼‚å¸¸é“¾ï¼Œä¸Šä¸‹æ–‡ä¿ç•™

#### èµ„æºç®¡ç† âœ…
```python
async with anyio.create_task_group() as tg:
    for node in layer:
        tg.start_soon(...)
# â† è‡ªåŠ¨ç­‰å¾…å®Œæˆæˆ–å–æ¶ˆ
```

**è¯„ä»·**: âœ… ç»“æ„åŒ–å¹¶å‘ï¼Œæ— æ³„æ¼

#### è¶…æ—¶ä¿æŠ¤ âš ï¸
```python
if current_step >= self.max_steps:
    raise WorkflowError(...)
```

**å½“å‰**: æ­¥æ•°é™åˆ¶  
**å»ºè®®**: æ·»åŠ æ—¶é—´é™åˆ¶  
**å½±å“**: ä½ï¼ˆå½“å‰è®¾è®¡åˆç†ï¼‰

---

### Part 6: å¯æ‰©å±•æ€§ â­â­â­â­â­

#### æ–°å¢ç­–ç•¥
```python
class ExecutionStrategy(str, Enum):
    ALL = "all"
    RACE = "race"
    # æ˜“æ‰©å±•: MAJORITY, BEST_OF_N, ...
```

**éš¾åº¦**: ä½ - å®Œå…¨ç‹¬ç«‹çš„å‡½æ•°

#### æ–°å¢èŠ‚ç‚¹ç±»å‹
```python
if hasattr(func, "run"):
    return await self._run_intelligent_object(func, context)
if callable(func):
    return await self._run_function(func, context)
# æ˜“æ‰©å±•: if isinstance(func, CustomType): ...
```

**éš¾åº¦**: ä½ - Duck Typing æœºåˆ¶

#### æ–°å¢åç«¯
```python
class RedisSessionManager(SessionInterface):
    async def save_checkpoint(self, ...):
        # Redis å®ç°
```

**éš¾åº¦**: ä½ - æ¥å£æ¸…æ™°

---

### Part 7: å·²éªŒè¯çš„æ ¸å¿ƒæœºåˆ¶

#### History æ¸…ç† (P1-2) âœ…
```python
def _cleanup_history(self, context, max_steps=20):
    # ä¿ç•™æœ€å 20 æ­¥ + last_output
    if len(context.history) <= max_steps:
        return
    must_keep = {"last_output"}
    all_keys = set(context.history.keys()) - must_keep
    old_keys = sorted(all_keys)[:-max_steps]
    for key in old_keys:
        del context.history[key]
```

**è¯„ä»·**: âœ… é˜²æ­¢æ— ç•Œå¢é•¿ï¼Œä¿ç•™å…³é”®æ•°æ®

#### æ¡ä»¶åˆ†æ”¯ âœ…
```python
if cond is None:
    should_run = True
    break
try:
    res = cond(ctx)
    if inspect.isawaitable(res):
        res = await res
    if res:
        should_run = True
except Exception:
    logger.error(...)  # Fail Safe
```

**è¯„ä»·**: âœ… æ”¯æŒåŒæ­¥/å¼‚æ­¥ï¼Œå¼‚å¸¸å®‰å…¨

#### åŠ¨æ€è·³è½¬ (Next) âœ…
```python
if isinstance(output, Next):
    if output.input is not None:
        actual_data = output.input
    else:
        actual_data = context.get_last_output()
```

**è¯„ä»·**: âœ… æ™ºèƒ½å¤„ç†ï¼Œè¯­ä¹‰æ˜ç¡®

---

## ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥æ¸…å•

```
åŠŸèƒ½æ€§:
  âœ… DAG æ‰§è¡Œ
  âœ… å¹¶è¡Œè°ƒåº¦
  âœ… åŠ¨æ€è·³è½¬
  âœ… æ¡ä»¶åˆ†æ”¯
  âœ… æ–­ç‚¹æ¢å¤
  âœ… å¤šæ™ºèƒ½ä½“

æ€§èƒ½:
  âœ… å¤§å‹ DAG (500+ èŠ‚ç‚¹)
  âœ… æ·±å†å²ä¼˜åŒ– (6-15x)
  âœ… å†…å­˜æœ‰ç•Œ
  âœ… çº¿æ€§æ‰©å±•

ç¨³å®šæ€§:
  âœ… å¼‚å¸¸å¤„ç†
  âœ… èµ„æºç®¡ç†
  âœ… æ•°æ®ä¸€è‡´
  âœ… ç¯æ£€æµ‹
  âœ… è¶…æ—¶ä¿æŠ¤ (steps)
  âš ï¸ å®æ—¶è¶…æ—¶ (å¯é€‰)

å¯é æ€§:
  âœ… é”™è¯¯æ¢å¤
  âœ… æŒä¹…åŒ–
  âœ… å¯è§‚æµ‹æ€§
  âœ… ç‰ˆæœ¬å…¼å®¹

ä»£ç è´¨é‡:
  âœ… ç±»å‹æ³¨è§£å®Œæ•´
  âœ… æ³¨é‡Šå……åˆ†
  âœ… å•å…ƒæµ‹è¯• 297/297
  âœ… æ€§èƒ½åŸºå‡† 6/6

æ€»ä½“: âœ… PASS
```

---

## æ”¹è¿›å»ºè®® (ä¼˜å…ˆçº§)

### ğŸ”´ Critical (ç«‹å³ä¿®å¤)

1. **_COWDict.pop() é˜²å¾¡ä¿®å¤**
   - **å·¥æ—¶**: 15 åˆ†é’Ÿ
   - **å½±å“**: å½“å‰æ— ï¼Œä½†é˜²å¾¡ç¼–ç¨‹
   - **é‡è¦æ€§**: ä»£ç è´¨é‡

### ğŸŸ¡ High (å¯é€‰)

2. **å®æ—¶è¶…æ—¶ä¿æŠ¤**
   - **å·¥æ—¶**: 1-2 å°æ—¶
   - **å½±å“**: é˜²æ­¢æ— é™ç­‰å¾…
   - **é‡è¦æ€§**: ç”Ÿäº§ç¨³å®šæ€§
   - **å‚è€ƒ**:
   ```python
   async def execute(self, ..., timeout: Optional[float] = None):
       async with anyio.move_on_after(timeout) if timeout else nullcontext():
           # æ‰§è¡Œé€»è¾‘
   ```

3. **æ€§èƒ½ç›‘æ§æ—¥å¿—**
   - **å·¥æ—¶**: 1 å°æ—¶
   - **å½±å“**: å¯è§‚æµ‹æ€§
   - **å‚è€ƒ**:
   ```python
   summary = context.get_summary()
   logger.info("Workflow completed", **summary)
   ```

### ğŸŸ¢ Low (é•¿æœŸ)

4. **æ¡ä»¶å‡½æ•°ç¼“å­˜** - å½“å‰ç¬¦åˆè®¾è®¡ï¼Œæ— éœ€ä¿®å¤
5. **History ç­–ç•¥é…ç½®** - å½“å‰ FIFO åˆç†ï¼Œå¯ä½œå¯é€‰åŠŸèƒ½

---

## æœ€ç»ˆç»“è®º

### ç»¼åˆè¯„åˆ†
| ç»´åº¦ | è¯„åˆ† |
|------|------|
| æ¶æ„è®¾è®¡ | â­â­â­â­â­ |
| åŠŸèƒ½æ­£ç¡®æ€§ | â­â­â­â­â­ |
| æ€§èƒ½æ•ˆç‡ | â­â­â­â­â­ |
| å¹¶å‘å®‰å…¨ | â­â­â­â­â­ |
| å®¹é”™èƒ½åŠ› | â­â­â­â­ |
| å¯è§‚æµ‹æ€§ | â­â­â­â­ |
| å¯æ‰©å±•æ€§ | â­â­â­â­â­ |
| ä»£ç è´¨é‡ | â­â­â­â­â­ |
| **å¹³å‡** | **â­â­â­â­â­ (4.75/5.0)** |

### æ¨èè¡ŒåŠ¨

âœ… **ç«‹å³éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ**

**å‰ç½®æ¡ä»¶** (å¯é€‰):
1. ä¿®å¤ _COWDict.pop() (15 min, å¯é€‰)
2. å¯é€‰: æ·»åŠ å®æ—¶è¶…æ—¶ (1-2h, éå…³é”®)

### æœ€ç»ˆè¯„ä»·

**Gecko Compose æ¨¡å—è®¾è®¡åˆç†ã€ä»£ç ä¼˜ç§€ã€æ€§èƒ½å“è¶Šã€å®Œå…¨ç¬¦åˆå·¥ä¸šçº§è½åœ°ä½¿ç”¨**

---

*å®¡æŸ¥æ—¥æœŸ: 2025-12-04*  
*å®¡æŸ¥æ–¹å¼: æ·±åº¦ä»£ç å®¡æŸ¥ + æ€§èƒ½åŸºå‡†éªŒè¯*  
*å®¡æŸ¥ç»“è®º: ç”Ÿäº§çº§åˆ«å°±ç»ª*  
*å»ºè®®: ç«‹å³éƒ¨ç½²*
